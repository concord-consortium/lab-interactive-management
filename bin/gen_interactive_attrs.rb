require 'rubygems'
require 'active_support/all'

# TODO: use a Rails generator

# make sure that this file reflects the latest interactive meta data
# interactive metadata is defined in that lab project at:
# src/lab/common/controllers/interactive-metadata.js
load "meta_data/interactive_metadata.rb"

serialized_attributes = []
$interactive_metadata.each do |k, v|
  prop_name = k.to_s
  if %w{ type created_at updated_at }.include?(prop_name)
    msg = "Error: Can not use a reserved name \"#{prop_name}\" for an attribute!!!"
    # raise msg
    puts msg
    prop_name = "_#{prop_name}"
    puts "Changed attribute name to #{prop_name}"
  end

  serialized_attributes << ":#{prop_name}"
end
serialized_attributes_str = "store :json_rep, :accessors => [" << serialized_attributes.join(', ') << ']'
#puts serialized_attributes_str

# code = <<-CODE.gsub(/^ {6}/, '')
code = <<-CODE
# Generated by #{$0}
# Depends on the definition of interactive in the lab project

# just use this in the Interactive AR model
module InteractiveStore
  extend ActiveSupport::Concern

  module ClassMethods
    # find the model where the json_rep['path'] == path
    def find_by_path(path)
      find do |g|
        g if g.json_rep['path'] == path
      end
    end
  end

  module InstanceMethods
  end

  included do
    # GENERATED
      #{serialized_attributes_str}
    # GENERATED
  end
end
CODE
# puts code

file_path = 'app/models/concerns/interactive_store.rb'
puts "Writing to #{file_path}"

File.open(file_path, 'w') do |f|
  f.write(code)
end
